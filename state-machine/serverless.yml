# To access resources defined in Terraform, we use SSM
# https://www.serverless.com/blog/definitive-guide-terraform-serverless/
#
# For full config options, check the docs:
#  - docs.serverless.com
#  - https://github.com/serverless/serverless/blob/master/docs/providers/aws/guide/serverless.yml.md
#

service: mentorpal-upload-sm

# pin to only deploy with a specific Serverless version
frameworkVersion: '2'

variablesResolutionMode: 20210326

# todo install drugin build:
# sls plugin install -n serverless-deployment-bucket
# sls plugin install -n serverless-offline
# sls plugin install -n serverless-layers

plugins:
  - serverless-deployment-bucket
  - serverless-offline
  - serverless-layers
custom:
  stages:
    offline:
      LOG_LEVEL: 'trace'
      S3_STATIC_ARN: arn:aws:s3:::static-mentorpal-offline-origin
    dev:
      LOG_LEVEL: 'trace'
      # v2 is hardcoded, we could use fallback stages instead
      S3_STATIC_ARN: ${ssm:/mentorpal/v2/s3_static_arn}
      TRANSCRIBE_AWS_S3_BUCKET_SOURCE: mentorpal-v2-mentorpal-transcribe-uploads
      TRANSCRIBE_AWS_SECRET_ACCESS_KEY: ${ssm:/mentorpal/v2/transcribe/access_key}
      TRANSCRIBE_AWS_ACCESS_KEY_ID: ${ssm:/mentorpal/v2/transcribe/secret_key}
    qa:
      # TODO
      # S3_STATIC_ARN: ${ssm:/mentorpal/${self:provider.stage}/s3_static_arn}
      LOG_LEVEL: 'debug'
      TRANSCRIBE_AWS_S3_BUCKET_SOURCE: mentorpal-v2-mentorpal-transcribe-uploads
      TRANSCRIBE_AWS_SECRET_ACCESS_KEY: ${ssm:/mentorpal/v2/transcribe/access_key}
      TRANSCRIBE_AWS_ACCESS_KEY_ID: ${ssm:/mentorpal/v2/transcribe/secret_key}
    prod:
      LOG_LEVEL: 'info'
      # TODO
      # S3_STATIC_ARN: ${ssm:/mentorpal/${self:provider.stage}/s3_static_arn}

  # serverless-layers requires a deployment bucket to be created before deploying this stack
  serverless-layers:
    - dependencies:
        layersDeploymentBucket: ${self:provider.deploymentBucket.name}
        dependenciesPath: ./requirements.txt
        compatibleRuntimes:
          - python3.7
          - python3.8
        # applies to all lambdas

  # serverless-offline:
  #   useDocker: true

provider:
  name: aws
  stage: ${opt:stage, 'dev'} # stage is dev unless otherwise specified with --stage flag
  deploymentBucket:
    name: '${self:service}-sls-deploy-${self:provider.stage}'
    blockPublicAccess: true
    serverSideEncryption: AES256
    versioning: false
  stackTags:
    ENVIRONMENT: ${self:provider.stage}
    PROJECT: ${self:service}-${self:provider.stage}
    REPOSITORY: mentor-upload
  runtime: python3.8
  lambdaHashingVersion: 20201221
  tracing:
    lambda: true
  logRetentionInDays: 30      
  region: us-east-1
  architecture: x86_64 # because of the static ffmpeg binaries and python dependencies
  environment:
    # IS_OFFLINE: ${env:IS_OFFLINE}
    STAGE: ${self:provider.stage}
    PYTHON_ENV: ${self:provider.stage}
    S3_STATIC_ARN: ${self:custom.stages.${self:provider.stage}.S3_STATIC_ARN}
    FFMPEG_EXECUTABLE: /opt/ffmpeg/ffmpeg
    TRANSCRIBE_MODULE_PATH: transcribe_aws
    TRANSCRIBE_AWS_REGION: ${self:provider.region}
    TRANSCRIBE_AWS_S3_BUCKET_SOURCE: mentorpal-v2-mentorpal-transcribe-uploads

  # iam permissions for all lambda functions
  iam:
    role:
      statements:
        - Effect: "Allow"
          Action:
            - "s3:PutObject"
            - "s3:GetObject"
          Resource:
            Fn::Join:
              - "/"
              - - ${self:custom.stages.${self:provider.stage}.S3_STATIC_ARN}
                - "*"

package:
#  individually: false
 patterns:
    # exclude everything:
     - '!./**'
    # and then add back in only the files we need:
     - '*.py'

layers:
  # binaries are shared and this will make lambdas size smaller
  binaries:
    path: ./binaries
    package:
      patterns:
        - '!./**'
        # relative to layer path:
        # when attached, these are available under /opt
        - ./ffmpeg/ffmpeg
        - './MediaInfo_DLL_21.09_Lambda/lib/**'
    name: binaries-layer-${self:provider.stage}
    description: Bundles ffmpeg and mediainfo binaries/libs
    compatibleArchitectures: # optional, a list of architectures this layer is compatible with
      - x86_64
    licenseInfo: GPLv3 # optional, a string specifying license information
    retain: false # If true, layer versions are not deleted as new ones are created

functions:
  answer-transcode-web:
    handler: answer-transcode-web.handler
    memorySize: 8192 # 5min video takes 100sec with 2GB, 50sec with 4GB, 30sec with 8GB
    timeout: 300
    environment:
      # sensitive data, better to just add it to lambdas that really need it:
      TRANSCRIBE_AWS_SECRET_ACCESS_KEY: ${self:custom.stages.${self:provider.stage}.TRANSCRIBE_AWS_SECRET_ACCESS_KEY}
      TRANSCRIBE_AWS_ACCESS_KEY_ID: ${self:custom.stages.${self:provider.stage}.TRANSCRIBE_AWS_ACCESS_KEY_ID}
    events:
      - sqs:
          arn:
            Fn::GetAtt: [TranscodeWebQueue, Arn]
    layers:
      # binaries gets named "Binaries"+"LambdaLayer":
      # see https://www.serverless.com/framework/docs/providers/aws/guide/layers#using-your-layers
      - { Ref: BinariesLambdaLayer }
  answer-transcode-mobile:
    handler: answer-transcode-mobile.handler
    memorySize: 8192 # 5min video takes 100sec with 2GB, 50sec with 4GB, 30sec with 8GB
    timeout: 300
    environment:
      # sensitive data, better to just add it to lambdas that really need it:
      TRANSCRIBE_AWS_SECRET_ACCESS_KEY: ${self:custom.stages.${self:provider.stage}.TRANSCRIBE_AWS_SECRET_ACCESS_KEY}
      TRANSCRIBE_AWS_ACCESS_KEY_ID: ${self:custom.stages.${self:provider.stage}.TRANSCRIBE_AWS_ACCESS_KEY_ID}
    events:
      - sqs:
          arn:
            Fn::GetAtt: [TranscodeMobileQueue, Arn]
    layers:
      # binaries gets named "Binaries"+"LambdaLayer":
      # see https://www.serverless.com/framework/docs/providers/aws/guide/layers#using-your-layers
      - { Ref: BinariesLambdaLayer }

resources:
  Resources:
    TranscodeWebDLQ:
      Type: AWS::SQS::Queue
      Properties:
        DelaySeconds: 30
        QueueName: upload-transcode-web-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600 # max 14 days, default is 4 days
    
    TranscodeMobileDLQ:
      Type: AWS::SQS::Queue
      Properties:
        DelaySeconds: 30
        QueueName: upload-transcode-mobile-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600 # max 14 days, default is 4 days

    TranscodeWebQueue:
      Type: AWS::SQS::Queue
      Properties:
        # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-sqs-queues.html
        QueueName: upload-trancode-web-queue-${self:provider.stage}
        VisibilityTimeout: 600 # default too low, we need to give lambdas time to finish processing
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt: [TranscodeWebDLQ, Arn]
          maxReceiveCount: 3 # try 3 times and them move to DLQ
    
    TranscodeMobileQueue:
      Type: AWS::SQS::Queue
      Properties:
        # https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-sqs-queues.html
        QueueName: upload-trancode-mobile-queue-${self:provider.stage}
        VisibilityTimeout: 600 # default too low, we need to give lambdas time to finish processing
        RedrivePolicy:
          deadLetterTargetArn:
            Fn::GetAtt: [TranscodeMobileDLQ, Arn]
          maxReceiveCount: 3 # try 3 times and them move to DLQ

    ProcessUploadSnsTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: 'mentor-upload-process-topic-${self:provider.stage}'
        Subscription:
          - Protocol: sqs
            Endpoint: 
              Fn::GetAtt: [TranscodeWebQueue, Arn]
          - Protocol: sqs
            Endpoint: 
              Fn::GetAtt: [TranscodeMobileQueue, Arn]

    SnsToSqsPolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Sid: "Allow SNS publish to SQS"
              Effect: Allow
              Principal: 
                Service: "sns.amazonaws.com"
              Resource:
                - Fn::GetAtt: [TranscodeWebQueue, Arn]
                - Fn::GetAtt: [TranscodeMobileQueue, Arn]
              Action: SQS:SendMessage
              Condition:
                ArnEquals:
                  aws:SourceArn: 
                    # return value is ARN, so no need for Fn::GetAtt
                    Ref: ProcessUploadSnsTopic
        Queues:
          - Ref: TranscodeWebQueue
          - Ref: TranscodeMobileQueue

  Outputs:
    ProcessUploadSnsTopicName:
      Description: SNS topic name
      Value: 
        Fn::GetAtt: [ProcessUploadSnsTopic, TopicName]
    ProcessUploadSnsTopicArn:
      Description: SNS topic ARN
      Value: 
        Ref: ProcessUploadSnsTopic
